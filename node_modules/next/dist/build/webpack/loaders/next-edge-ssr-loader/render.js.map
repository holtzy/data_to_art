{"version":3,"sources":["../../../../../src/build/webpack/loaders/next-edge-ssr-loader/render.ts"],"sourcesContent":["import type { NextConfigComplete } from '../../../../server/config-shared'\n\nimport type { DocumentType, AppType } from '../../../../shared/lib/utils'\nimport type { BuildManifest } from '../../../../server/get-page-files'\nimport type {\n  DynamicCssManifest,\n  ReactLoadableManifest,\n} from '../../../../server/load-components'\nimport type { ClientReferenceManifest } from '../../plugins/flight-manifest-plugin'\nimport type { NextFontManifest } from '../../plugins/next-font-manifest-plugin'\nimport type { NextFetchEvent } from '../../../../server/web/spec-extension/fetch-event'\n\nimport WebServer from '../../../../server/web-server'\nimport {\n  WebNextRequest,\n  WebNextResponse,\n} from '../../../../server/base-http/web'\nimport { SERVER_RUNTIME } from '../../../../lib/constants'\nimport type { ManifestRewriteRoute } from '../../..'\nimport { normalizeAppPath } from '../../../../shared/lib/router/utils/app-paths'\nimport type { SizeLimit } from '../../../../types'\nimport { internal_getCurrentFunctionWaitUntil } from '../../../../server/web/internal-edge-wait-until'\nimport type { PAGE_TYPES } from '../../../../lib/page-types'\nimport type { NextRequestHint } from '../../../../server/web/adapter'\n\nexport function getRender({\n  dev,\n  page,\n  appMod,\n  pageMod,\n  errorMod,\n  error500Mod,\n  pagesType,\n  Document,\n  buildManifest,\n  reactLoadableManifest,\n  dynamicCssManifest,\n  interceptionRouteRewrites,\n  renderToHTML,\n  clientReferenceManifest,\n  subresourceIntegrityManifest,\n  serverActionsManifest,\n  serverActions,\n  config,\n  buildId,\n  nextFontManifest,\n  incrementalCacheHandler,\n}: {\n  pagesType: PAGE_TYPES\n  dev: boolean\n  page: string\n  appMod: any\n  pageMod: any\n  errorMod: any\n  error500Mod: any\n  renderToHTML?: any\n  Document: DocumentType\n  buildManifest: BuildManifest\n  reactLoadableManifest: ReactLoadableManifest\n  dynamicCssManifest?: DynamicCssManifest\n  subresourceIntegrityManifest?: Record<string, string>\n  interceptionRouteRewrites?: ManifestRewriteRoute[]\n  clientReferenceManifest?: ClientReferenceManifest\n  serverActionsManifest?: any\n  serverActions?: {\n    bodySizeLimit?: SizeLimit\n    allowedOrigins?: string[]\n  }\n  config: NextConfigComplete\n  buildId: string\n  nextFontManifest: NextFontManifest\n  incrementalCacheHandler?: any\n}) {\n  const isAppPath = pagesType === 'app'\n  const baseLoadComponentResult = {\n    dev,\n    buildManifest,\n    reactLoadableManifest,\n    dynamicCssManifest,\n    subresourceIntegrityManifest,\n    Document,\n    App: appMod?.default as AppType,\n    clientReferenceManifest,\n  }\n\n  const server = new WebServer({\n    dev,\n    buildId,\n    conf: config,\n    minimalMode: true,\n    webServerConfig: {\n      page,\n      pathname: isAppPath ? normalizeAppPath(page) : page,\n      pagesType,\n      interceptionRouteRewrites,\n      extendRenderOpts: {\n        runtime: SERVER_RUNTIME.experimentalEdge,\n        supportsDynamicResponse: true,\n        disableOptimizedLoading: true,\n        serverActionsManifest,\n        serverActions,\n        nextFontManifest,\n        devtoolSegmentExplorer: config.experimental.devtoolSegmentExplorer,\n      },\n      renderToHTML,\n      incrementalCacheHandler,\n      loadComponent: async (inputPage) => {\n        if (inputPage === page) {\n          return {\n            ...baseLoadComponentResult,\n            Component: pageMod.default,\n            pageConfig: pageMod.config || {},\n            getStaticProps: pageMod.getStaticProps,\n            getServerSideProps: pageMod.getServerSideProps,\n            getStaticPaths: pageMod.getStaticPaths,\n            ComponentMod: pageMod,\n            isAppPath: !!pageMod.__next_app__,\n            page: inputPage,\n            routeModule: pageMod.routeModule,\n          }\n        }\n\n        // If there is a custom 500 page, we need to handle it separately.\n        if (inputPage === '/500' && error500Mod) {\n          return {\n            ...baseLoadComponentResult,\n            Component: error500Mod.default,\n            pageConfig: error500Mod.config || {},\n            getStaticProps: error500Mod.getStaticProps,\n            getServerSideProps: error500Mod.getServerSideProps,\n            getStaticPaths: error500Mod.getStaticPaths,\n            ComponentMod: error500Mod,\n            page: inputPage,\n            routeModule: error500Mod.routeModule,\n          }\n        }\n\n        if (inputPage === '/_error') {\n          return {\n            ...baseLoadComponentResult,\n            Component: errorMod.default,\n            pageConfig: errorMod.config || {},\n            getStaticProps: errorMod.getStaticProps,\n            getServerSideProps: errorMod.getServerSideProps,\n            getStaticPaths: errorMod.getStaticPaths,\n            ComponentMod: errorMod,\n            page: inputPage,\n            routeModule: errorMod.routeModule,\n          }\n        }\n\n        return null\n      },\n    },\n  })\n\n  const handler = server.getRequestHandler()\n\n  return async function render(\n    request: NextRequestHint,\n    event?: NextFetchEvent\n  ) {\n    const extendedReq = new WebNextRequest(request)\n    const extendedRes = new WebNextResponse(undefined)\n\n    handler(extendedReq, extendedRes)\n    const result = await extendedRes.toResponse()\n    request.fetchMetrics = extendedReq.fetchMetrics\n\n    if (event?.waitUntil) {\n      // TODO(after):\n      // remove `internal_runWithWaitUntil` and the `internal-edge-wait-until` module\n      // when consumers switch to `after`.\n      const waitUntilPromise = internal_getCurrentFunctionWaitUntil()\n      if (waitUntilPromise) {\n        event.waitUntil(waitUntilPromise)\n      }\n    }\n\n    return result\n  }\n}\n"],"names":["getRender","dev","page","appMod","pageMod","errorMod","error500Mod","pagesType","Document","buildManifest","reactLoadableManifest","dynamicCssManifest","interceptionRouteRewrites","renderToHTML","clientReferenceManifest","subresourceIntegrityManifest","serverActionsManifest","serverActions","config","buildId","nextFontManifest","incrementalCacheHandler","isAppPath","baseLoadComponentResult","App","default","server","WebServer","conf","minimalMode","webServerConfig","pathname","normalizeAppPath","extendRenderOpts","runtime","SERVER_RUNTIME","experimentalEdge","supportsDynamicResponse","disableOptimizedLoading","devtoolSegmentExplorer","experimental","loadComponent","inputPage","Component","pageConfig","getStaticProps","getServerSideProps","getStaticPaths","ComponentMod","__next_app__","routeModule","handler","getRequestHandler","render","request","event","extendedReq","WebNextRequest","extendedRes","WebNextResponse","undefined","result","toResponse","fetchMetrics","waitUntil","waitUntilPromise","internal_getCurrentFunctionWaitUntil"],"mappings":"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","ignoreList":[0]}